{% extends 'base.html' %}
{% load static %}

{% block title %}Уведомления{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Левая боковая панель -->
        <div class="col-lg-2 col-md-3 bg-light border-end min-vh-100">
            <div class="profile-section p-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="avatar me-3">
                        <i class="bi bi-person-circle fs-2 text-primary"></i>
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold">{{ user.username }}</h6>
                        <small class="text-muted">{{ user.email|default:"Email не указан" }}</small>
                    </div>
                </div>
                <a href="{% url 'profile' %}" class="btn btn-sm btn-outline-primary w-100 mt-3">
                    <i class="bi bi-gear me-1"></i> Профиль
                </a>
            </div>

            <nav class="nav flex-column p-3">
                <a class="nav-link" href="{% url 'main' %}">
                    <i class="bi bi-house me-2"></i> Главная
                </a>
                <a class="nav-link" href="{% url 'my_events' %}">
                    <i class="bi bi-calendar-event me-2"></i> Мои мероприятия
                </a>
                <a class="nav-link" href="{% url 'create_event' %}">
                    <i class="bi bi-plus-circle me-2"></i> Создать мероприятие
                </a>
                <a class="nav-link" href="{% url 'calendar' %}">
                    <i class="bi bi-calendar-week me-2"></i> Календарь
                </a>
                <a class="nav-link" href="{% url 'friends' %}">
                    <i class="bi bi-people me-2"></i> Друзья
                </a>
                <a class="nav-link active" href="#">
                    <i class="bi bi-bell me-2"></i> Уведомления
                    <span class="badge bg-danger ms-1" id="unreadCount">0</span>
                </a>
                <a class="nav-link" href="{% url 'map' %}">
                    <i class="bi bi-map me-2"></i> Карта
                </a>
                <a class="nav-link" href="{% url 'settings' %}">
                    <i class="bi bi-sliders me-2"></i> Настройки
                </a>
            </nav>
        </div>

        <!-- Основной контент -->
        <div class="col-lg-10 col-md-9 py-4">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 col-xl-8 mx-auto">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h4 class="mb-0 fw-bold">
                                    <i class="bi bi-bell me-2"></i>Мои уведомления
                                </h4>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" id="markAllReadBtn">
                                        <i class="bi bi-check-all me-1"></i> Прочитать все
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="clearNotificationsBtn">
                                        <i class="bi bi-trash me-1"></i> Очистить
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="notificationsContainer">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Загрузка...</span>
                                        </div>
                                        <p class="mt-2">Загружаем уведомления...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Страница уведомлений загружена');

    // Загружаем уведомления
    loadNotifications();

    // Кнопка "Прочитать все"
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            markAllAsRead();
        });
    }

    // Кнопка "Очистить"
    const clearBtn = document.getElementById('clearNotificationsBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            clearAllNotifications();
        });
    }
});

// Функция загрузки уведомлений
async function loadNotifications() {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;

    try {
        const response = await fetch('/notifications/api/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.success && data.notifications.length > 0) {
            renderNotifications(data.notifications);
            updateUnreadCount(data.unread_count);
        } else {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-bell-slash display-1 text-muted"></i>
                    <h5 class="mt-3">Уведомлений нет</h5>
                    <p class="text-muted">Здесь будут появляться уведомления о приглашениях и событиях</p>
                </div>
            `;
            updateUnreadCount(0);
        }

    } catch (error) {
        console.error('Ошибка загрузки уведомлений:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Ошибка загрузки уведомлений
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadNotifications()">
                    <i class="bi bi-arrow-clockwise"></i> Повторить
                </button>
            </div>
        `;
    }
}

// Функция отображения уведомлений
function renderNotifications(notifications) {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;

    let html = '<div class="list-group list-group-flush">';

    notifications.forEach(notification => {
        // Иконка по типу уведомления
        let icon = 'bi-bell';
        let bgClass = notification.is_read ? '' : 'bg-light';

        switch(notification.type) {
            case 'event_invitation':
                icon = 'bi-calendar-plus';
                bgClass = notification.is_read ? '' : 'bg-warning bg-opacity-10';
                break;
            case 'friend_request':
                icon = 'bi-person-plus';
                bgClass = notification.is_read ? '' : 'bg-primary bg-opacity-10';
                break;
            case 'event_update':
                icon = 'bi-calendar-event';
                break;
        }

        html += `
            <div class="list-group-item ${bgClass} border-0 py-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi ${icon} fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-0 ${notification.is_read ? '' : 'fw-bold'}">${notification.title}</h6>
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>${notification.created_at}
                                    ${notification.from_user ? ` • От: ${notification.from_user}` : ''}
                                </small>
                            </div>
                        </div>
                        <p class="mb-2">${notification.message}</p>



${notification.type === 'event_invitation' && notification.event_id ? `
    <div class="mt-3">
        <button class="btn btn-sm btn-success me-2 accept-invitation-btn"
                data-event-id="${notification.event_id}"
                data-notification-id="${notification.id}">
            <i class="bi bi-check-circle me-1"></i> Принять приглашение
        </button>
        <button class="btn btn-sm btn-outline-danger decline-invitation-btn"
                data-event-id="${notification.event_id}"
                data-notification-id="${notification.id}">
            <i class="bi bi-x-circle me-1"></i> Отклонить
        </button>
        <a href="/events/${notification.event_id}/" class="btn btn-sm btn-outline-primary ms-2">
            <i class="bi bi-eye me-1"></i> Посмотреть мероприятие
        </a>
    </div>
` : ''}
                    </div>
                    ${!notification.is_read ? `
                        <span class="badge bg-danger rounded-pill">Новое</span>
                    ` : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;

    // Добавляем обработчики для кнопок принятия/отклонения
    addInvitationHandlers();
}

// В notifications.html УДАЛИТЕ старую функцию и ВСТАВЬТЕ эту:

// Вспомогательная функция для получения participant_id
async function getParticipantIdForNotification(notification) {
    console.log('Получение participant_id для уведомления:', notification);

    if (!notification.event_id) {
        console.log('Нет event_id в уведомлении');
        return null;
    }

    try {
        // Запрашиваем participant_id с сервера
        const response = await fetch(`/api/events/${notification.event_id}/my-participant/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        console.log('Response status:', response.status);

        // Проверяем что это JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Сервер вернул не JSON:', contentType);
            return null;
        }

        const data = await response.json();
        console.log('Получены данные:', data);

        if (data.success && data.participant_id) {
            return data.participant_id;
        } else {
            console.log('Participant не найден:', data.error);
            return null;
        }

    } catch (error) {
        console.error('Ошибка получения participant_id:', error);
        return null;
    }
}

// Добавление обработчиков для кнопок принятия/отклонения
function addInvitationHandlers() {
    // Кнопки "Принять"
    document.querySelectorAll('.accept-invitation-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const eventId = this.getAttribute('data-event-id');
            const notificationId = this.getAttribute('data-notification-id');

            // Получаем participant_id
            const participantId = await getParticipantIdForEvent(eventId);
            if (!participantId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Не удалось найти приглашение'
                });
                return;
            }

            await respondToInvitation(participantId, 'accept');
        });
    });

    // Кнопки "Отклонить"
    document.querySelectorAll('.decline-invitation-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const eventId = this.getAttribute('data-event-id');
            const notificationId = this.getAttribute('data-notification-id');

            // Получаем participant_id
            const participantId = await getParticipantIdForEvent(eventId);
            if (!participantId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка',
                    text: 'Не удалось найти приглашение'
                });
                return;
            }

            await respondToInvitation(participantId, 'decline');
        });
    });
}

// Функция получения participant_id для мероприятия
async function getParticipantIdForEvent(eventId) {
    try {
        const response = await fetch(`/api/events/${eventId}/my-participant/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await response.json();

        if (data.success && data.participant_id) {
            return data.participant_id;
        } else {
            console.log('Participant не найден:', data.error);
            return null;
        }

    } catch (error) {
        console.error('Ошибка получения participant_id:', error);
        return null;
    }
}

// Функция ответа на приглашение
async function respondToInvitation(participantId, action) {
    if (!participantId) {
        alert('Ошибка: не найден ID приглашения');
        return;
    }

    const actionText = action === 'accept' ? 'принять' : 'отклонить';

    // Подтверждение
    const result = await Swal.fire({
        title: `Вы уверены?`,
        html: `Вы хотите <strong>${actionText}</strong> это приглашение?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Да, ${actionText}`,
        cancelButtonText: 'Отмена',
        confirmButtonColor: action === 'accept' ? '#198754' : '#dc3545'
    });

    if (!result.isConfirmed) return;

    try {
        // Отправляем запрос
        const response = await fetch(`/events/invitation/${participantId}/respond/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ action: action })
        });

        const data = await response.json();

        if (data.success) {
            // Показываем уведомление
            const icon = action === 'accept' ? 'success' : 'info';
            const title = action === 'accept' ? 'Приглашение принято!' : 'Приглашение отклонено';

            await Swal.fire({
                icon: icon,
                title: title,
                text: data.message,
                showConfirmButton: false,
                timer: 2000
            });

            // Обновляем уведомления
            setTimeout(() => {
                loadNotifications();
            }, 500);

        } else {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: data.error || 'Не удалось обработать приглашение'
            });
        }

    } catch (error) {
        console.error('Ошибка:', error);
        Swal.fire({
            icon: 'error',
            title: 'Ошибка соединения',
            text: 'Не удалось подключиться к серверу'
        });
    }
}

// Функция обновления счетчика непрочитанных
function updateUnreadCount(count) {
    const unreadEl = document.getElementById('unreadCount');
    if (unreadEl) {
        unreadEl.textContent = count;
        if (count > 0) {
            unreadEl.classList.remove('d-none');
            // Анимация пульсации
            unreadEl.classList.add('pulse-animation');
        } else {
            unreadEl.classList.add('d-none');
            unreadEl.classList.remove('pulse-animation');
        }
    }
}

// Функция пометки всех как прочитанных
async function markAllAsRead() {
    try {
        const response = await fetch('/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Обновляем интерфейс
            loadNotifications();
            
            Swal.fire({
                icon: 'success',
                title: 'Готово!',
                text: data.message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: data.error || 'Не удалось пометить как прочитанные'
            });
        }
        
    } catch (error) {
        console.error('Ошибка:', error);
        Swal.fire({
            icon: 'error',
            title: 'Ошибка соединения',
            text: 'Не удалось подключиться к серверу'
        });
    }
}

// Функция очистки всех уведомлений
async function clearAllNotifications() {
    const result = await Swal.fire({
        title: 'Очистить все уведомления?',
        html: `
            <div class="text-start">
                <p>Все ваши уведомления будут удалены. Это действие нельзя отменить.</p>
                <p class="text-muted small">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Уведомления исчезнут и после обновления страницы
                </p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-trash me-1"></i> Да, очистить',
        cancelButtonText: '<i class="bi bi-x-circle me-1"></i> Отмена',
        confirmButtonColor: '#dc3545'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch('/notifications/clear/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Обновляем интерфейс
            const container = document.getElementById('notificationsContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle display-1 text-success"></i>
                        <h5 class="mt-3">Уведомления очищены</h5>
                        <p class="text-muted">${data.message}</p>
                    </div>
                `;
            }
            
            updateUnreadCount(0);
            
            Swal.fire({
                icon: 'success',
                title: 'Очищено!',
                text: data.message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: data.error || 'Не удалось очистить уведомления'
            });
        }
        
    } catch (error) {
        console.error('Ошибка:', error);
        Swal.fire({
            icon: 'error',
            title: 'Ошибка соединения',
            text: 'Не удалось подключиться к серверу'
        });
    }
}
</script>
{% endblock %}

{% block extra_css %}
<style>
.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.bg-primary.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

/* Стили для активной ссылки в сайдбаре */
.nav-link.active {
    background-color: #e7f1ff;
    border-left: 3px solid #0d6efd;
    color: #0d6efd !important;
    font-weight: 500;
}

.nav-link {
    color: #495057;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 0.25rem;
    transition: all 0.2s;
}

.nav-link:hover {
    background-color: #f8f9fa;
    color: #0d6efd;
}

/* Аватарки */
.avatar {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-weight: bold;
}

/* Для высоты сайдбара */
.min-vh-100 {
    min-height: 100vh;
}
</style>
{% endblock %}